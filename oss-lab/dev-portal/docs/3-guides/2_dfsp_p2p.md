# 2. Peer to Peer Transaction

This guide takes you through the process of issuing a Peer to Peer (P2P) transaction from your DFSP to another DFSP.

<!-- TODO: nice pretty picture -->
A Mojaloop Transaction takes 3 distict phases: 
1. Party Lookup
2. Quoting
3. Transfer


## 1. Prerequisites

- Completed the [DFSP setup guide](/3-guides/1_dfsp_setup) and are succesfully recieving callbacks from the Mojaloop Sandbox

</br>
---



## 2. Party Lookup

```
GET /parties/{Type}/{ID}
```

The party lookup phase is where we lookup an identifier provided by _your end user_, and find out more information about the person (party in Mojaloop speak) that your user wants to send funds to. In the real world after recieiving the `PUT /parties/{Type}/{ID}` callback response from the Mojaloop switch, you will confirm the data with your end user. 

```bash
curl -v beta.moja-lab.live/api/fspiop/parties/MSISDN/27713803912 \
  -H 'Accept: application/vnd.interoperability.parties+json;version=1' \
  -H 'Content-Type: application/vnd.interoperability.parties+json;version=1.0' \
  -H 'FSPIOP-Source: applebank' \
  -H 'Date: 2021-01-01'
```

**Callback:**
`PUT /parties/MSISDN/27713803912`
```json
# formatted body
{
  "party": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "27713803912",
      "fspId": "payeefsp"
    },
    "personalInfo": {
      "complexName": {
        "firstName": "Test",
        "middleName": "Test",
        "lastName": "Test"
      },
      "dateOfBirth": "1984-01-01"
    },
    "name": "Test"
  }
}
```

## 3. Quote
 
```
POST /quotes
```

After your user has confirmed the details of the end user, it's time to get a quote from the Payer DFSP about the fees associated with the transaction.

You can ask your user either _"How much money do you want to send?"_ or _"How much money would you like the receiver to receive?"_. In this example, we will the `RECEIVE_AMOUNT`, which is to say _"How much money would you like the receiver to receive?"_.

After receiving the quote response callback at `PUT /quotes/{ID}`, you can then inform your user of the fees associated with the transaction, and ask them whether or not they would liike to continue.

Referring to the [API Specification](https://docs.mojaloop.io/mojaloop-specification/documents/API%20Definition%20v1.0.html#6522-post-quotes), we can build our example `POST /quotes` request.

Here's a simple explanation of the key parameters we need to set:

- `headers.Accept` - `application/vnd.interoperability.quotes+json;version=1.0`
- `headers.Content-Type` - `application/vnd.interoperability.quotes+json;version=1.0` 
- `headers.Date` - The RFC 2822 formatted date the request was made
- `headers.FSPIOP-Source` - which DFSP is sending the request. In our example case, that is `applebank`
- `headers.FSPIOP-Destination` - which DFSP we are sending the quote request to. We can find this by looking at the request body of the `PUT /parties` response. In our case, that is `payeefsp`

- `body.quoteId` - a random UUID, generated by you.
- `body.transactionId` - a random UUID, generated by you
- `body.payer` - This complex object is the SENDER of the transfer, or your (as the sending DFSP's) customer
- `body.payee` - The RECIEVE of the transfer. We can copy in the `PUT /parties` response callback for this field

> **Note: Generating a UUID**
> - For MacOS or Linux users, you can use `uuidgen` to make a UUID for you: `uuidgen | awk '{print tolower($0)}'`
> - https://www.uuidgenerator.net/version4 is also a good option for quickly and easily generating UUIDs
> Alternatively, you can copy and paste the UUIDs in this guide and change a few digits at random


Here's an example quote:
```json
{
  "quoteId": "387ee6b9-520d-4c51-a9e4-6eb2ef15887a",
  "transactionId": "387ee6b9-520d-4c51-a9e4-6eb2ef15887b",
  "payer": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "947947947947",
      "fspId": "applebank"
    },
    "personalInfo": {
      "complexName": {
        "firstName": "Mats",
        "lastName": "Hagman"
      },
      "dateOfBirth": "1983-10-25"
    }
  },
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "27713803912",
      "fspId": "payeefsp"
    }
  },
  "amountType": "SEND",
  "amount": {
    "amount": "10",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "note": "Test p2p transfer"
}
```

And as a full request:

```bash
curl -X POST http://beta.moja-lab.live/api/fspiop/quotes \
  -H 'Accept: application/vnd.interoperability.quotes+json;version=1.0' \
  -H 'Content-Type: application/vnd.interoperability.quotes+json;version=1.0' \
  -H 'Date: Mon, 11 Jan 2021 00:00:00 GMT' \
  -H 'FSPIOP-Source: applebank' \
  -H 'FSPIOP-Destination: payeefsp' \
  -d '{
  "quoteId": "387ee6b9-520d-4c51-a9e4-6eb2ef15887a",
  "transactionId": "387ee6b9-520d-4c51-a9e4-6eb2ef15887b",
  "payer": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "947947947947",
      "fspId": "applebank"
    },
    "personalInfo": {
      "complexName": {
        "firstName": "Mats",
        "lastName": "Hagman"
      },
      "dateOfBirth": "1983-10-25"
    }
  },
  "payee": {
    "partyIdInfo": {
      "partyIdType": "MSISDN",
      "partyIdentifier": "27713803912",
      "fspId": "payeefsp"
    }
  },
  "amountType": "SEND",
  "amount": {
    "amount": "10",
    "currency": "USD"
  },
  "transactionType": {
    "scenario": "TRANSFER",
    "initiator": "PAYER",
    "initiatorType": "CONSUMER"
  },
  "note": "Test p2p transfer"
}'
```

**Callback:**
`PUT /quotes/387ee6b9-520d-4c51-a9e4-6eb2ef15887a`
```json
# formatted body
{
  "transferAmount": {
    "amount": "10",
    "currency": "USD"
  },
  "expiration": "2021-01-11T05:46:41.943Z",
  "ilpPacket": "AYIC9gAAAAAAAAPoHWcucGF5ZWVmc3AubXNpc2RuLjI3NzEzODAzOTEyggLMZXlKMGNtRnVjMkZqZEdsdmJrbGtJam9pTXpnM1pXVTJZamt0TlRJd1pDMDBZelV4TFdFNVpUUXRObVZpTW1WbU1UVTRPRGRpSWl3aWNYVnZkR1ZKWkNJNklqTTROMlZsTm1JNUxUVXlNR1F0TkdNMU1TMWhPV1UwTFRabFlqSmxaakUxT0RnM1lTSXNJbkJoZVdWbElqcDdJbkJoY25SNVNXUkpibVp2SWpwN0luQmhjblI1U1dSVWVYQmxJam9pVFZOSlUwUk9JaXdpY0dGeWRIbEpaR1Z1ZEdsbWFXVnlJam9pTWpjM01UTTRNRE01TVRJaUxDSm1jM0JKWkNJNkluQmhlV1ZsWm5Od0luMTlMQ0p3WVhsbGNpSTZleUp3WVhKMGVVbGtTVzVtYnlJNmV5SndZWEowZVVsa1ZIbHdaU0k2SWsxVFNWTkVUaUlzSW5CaGNuUjVTV1JsYm5ScFptbGxjaUk2SWprME56azBOemswTnprME55SXNJbVp6Y0Vsa0lqb2lZWEJ3YkdWaVlXNXJJbjBzSW5CbGNuTnZibUZzU1c1bWJ5STZleUpqYjIxd2JHVjRUbUZ0WlNJNmV5Sm1hWEp6ZEU1aGJXVWlPaUpOWVhSeklpd2liR0Z6ZEU1aGJXVWlPaUpJWVdkdFlXNGlmU3dpWkdGMFpVOW1RbWx5ZEdnaU9pSXhPVGd6TFRFd0xUSTFJbjE5TENKaGJXOTFiblFpT25zaVlXMXZkVzUwSWpvaU1UQWlMQ0pqZFhKeVpXNWplU0k2SWxWVFJDSjlMQ0owY21GdWMyRmpkR2x2YmxSNWNHVWlPbnNpYzJObGJtRnlhVzhpT2lKVVVrRk9VMFpGVWlJc0ltbHVhWFJwWVhSdmNpSTZJbEJCV1VWU0lpd2lhVzVwZEdsaGRHOXlWSGx3WlNJNklrTlBUbE5WVFVWU0luMTkA",
  "condition": "il1Z7j26cQt8WeIDHjadZaYKDKavNiUFXsaESeW558E",
  "payeeFspFee": {
    "amount": "0",
    "currency": "USD"
  },
  "payeeFspCommission": {
    "amount": "0",
    "currency": "USD"
  }
}
```

If all went well, you will recieve a callback similar to the above. Check out [this section of the API Definition](https://docs.mojaloop.io/mojaloop-specification/documents/API%20Definition%20v1.0.html#6531-put-quotesid) for an explainer of what these fields mean.

## 4. Transfer

```
POST /transfers
```
Once you have confirmed the transaction details with your end user, and they have confirmed they would like to proceed with the transaction, you can issue a `POST /tranfers`. 

This request moves the funds from your users account to the Payee user.

Take a look at [this section of the API Specification](https://docs.mojaloop.io/mojaloop-specification/documents/API%20Definition%20v1.0.html#6722-post-transfers) for a detailed look at how to form the transfer request, but in short:

- `headers.Accept` - `application/vnd.interoperability.transfers+json;version=1.0`
- `headers.Content-Type` - `application/vnd.interoperability.transfers+json;version=1.0` 
- `headers.Date` - The RFC 2822 formatted date the request was made
- `FSPIOP-Source` - which DFSP is sending the request. In our example case, that is `applebank`
- `FSPIOP-Destination` - which DFSP we are sending the quote request to. We can find this by looking at the request body of the `PUT /parties` response. In our case, that is `payeefsp`

- `body.transferId` - a random UUID, generated by you
- `body.payerFsp` - Your DFSP_ID, in this case `applebank`
- `body.payeeFsp` - [t
- `body.amount` - The same amount field from the `POST /quotes` request
- `body.expiration` - ISO Formatted string - when the transfer request will expire and be rolled back. This must be set to some time in the future.
- `body.ilpPacket` - The `ilpPacket` specified by the Payee DFSP in the `PUT /quotes` callback.
- `body.condition` - The `condition` specified by the Payee DFSP in the `PUT /quotes` callback.
> Note: Read more about the condition and fulfillment [here](https://docs.mojaloop.io/mojaloop-specification/documents/API%20Definition%20v1.0.html#44-conditional-transfers)


Here's an example Transfer request body:
```json
{
  "transferId": "387ee6b9-520d-4c51-a9e4-6eb2ef15887e",
  "payerFsp": "applebank",
  "payeeFsp": "payeefsp",
  "amount": {
    "amount": "10",
    "currency": "USD"
  },
  "expiration": "2021-01-25T00:00:00.000Z",
  "ilpPacket": "AYIC9gAAAAAAAAPoHWcucGF5ZWVmc3AubXNpc2RuLjI3NzEzODAzOTEyggLMZXlKMGNtRnVjMkZqZEdsdmJrbGtJam9pTXpnM1pXVTJZamt0TlRJd1pDMDBZelV4TFdFNVpUUXRObVZpTW1WbU1UVTRPRGRpSWl3aWNYVnZkR1ZKWkNJNklqTTROMlZsTm1JNUxUVXlNR1F0TkdNMU1TMWhPV1UwTFRabFlqSmxaakUxT0RnM1lTSXNJbkJoZVdWbElqcDdJbkJoY25SNVNXUkpibVp2SWpwN0luQmhjblI1U1dSVWVYQmxJam9pVFZOSlUwUk9JaXdpY0dGeWRIbEpaR1Z1ZEdsbWFXVnlJam9pTWpjM01UTTRNRE01TVRJaUxDSm1jM0JKWkNJNkluQmhlV1ZsWm5Od0luMTlMQ0p3WVhsbGNpSTZleUp3WVhKMGVVbGtTVzVtYnlJNmV5SndZWEowZVVsa1ZIbHdaU0k2SWsxVFNWTkVUaUlzSW5CaGNuUjVTV1JsYm5ScFptbGxjaUk2SWprME56azBOemswTnprME55SXNJbVp6Y0Vsa0lqb2lZWEJ3YkdWaVlXNXJJbjBzSW5CbGNuTnZibUZzU1c1bWJ5STZleUpqYjIxd2JHVjRUbUZ0WlNJNmV5Sm1hWEp6ZEU1aGJXVWlPaUpOWVhSeklpd2liR0Z6ZEU1aGJXVWlPaUpJWVdkdFlXNGlmU3dpWkdGMFpVOW1RbWx5ZEdnaU9pSXhPVGd6TFRFd0xUSTFJbjE5TENKaGJXOTFiblFpT25zaVlXMXZkVzUwSWpvaU1UQWlMQ0pqZFhKeVpXNWplU0k2SWxWVFJDSjlMQ0owY21GdWMyRmpkR2x2YmxSNWNHVWlPbnNpYzJObGJtRnlhVzhpT2lKVVVrRk9VMFpGVWlJc0ltbHVhWFJwWVhSdmNpSTZJbEJCV1VWU0lpd2lhVzVwZEdsaGRHOXlWSGx3WlNJNklrTlBUbE5WVFVWU0luMTkA",
  "condition": "il1Z7j26cQt8WeIDHjadZaYKDKavNiUFXsaESeW558E"
}
```

And an example full request:
```bash
curl -X POST http://beta.moja-lab.live/api/fspiop/transfers \
  -H 'Accept: application/vnd.interoperability.transfers+json;version=1.0' \
  -H 'Content-Type: application/vnd.interoperability.transfers+json;version=1.0' \
  -H 'Date: Mon, 11 Jan 2021 00:00:00 GMT' \
  -H 'FSPIOP-Source: applebank' \
  -H 'FSPIOP-Destination: payeefsp' \
  -d '{
    "transferId": "387ee6b9-520d-4c51-a9e4-6eb2ef15887e",
    "payerFsp": "applebank",
    "payeeFsp": "payeefsp",
    "amount": {
      "amount": "10",
      "currency": "USD"
    },
    "expiration": "2021-01-25T00:00:00.000Z",
    "ilpPacket": "AYIC9gAAAAAAAAPoHWcucGF5ZWVmc3AubXNpc2RuLjI3NzEzODAzOTEyggLMZXlKMGNtRnVjMkZqZEdsdmJrbGtJam9pTXpnM1pXVTJZamt0TlRJd1pDMDBZelV4TFdFNVpUUXRObVZpTW1WbU1UVTRPRGRpSWl3aWNYVnZkR1ZKWkNJNklqTTROMlZsTm1JNUxUVXlNR1F0TkdNMU1TMWhPV1UwTFRabFlqSmxaakUxT0RnM1lTSXNJbkJoZVdWbElqcDdJbkJoY25SNVNXUkpibVp2SWpwN0luQmhjblI1U1dSVWVYQmxJam9pVFZOSlUwUk9JaXdpY0dGeWRIbEpaR1Z1ZEdsbWFXVnlJam9pTWpjM01UTTRNRE01TVRJaUxDSm1jM0JKWkNJNkluQmhlV1ZsWm5Od0luMTlMQ0p3WVhsbGNpSTZleUp3WVhKMGVVbGtTVzVtYnlJNmV5SndZWEowZVVsa1ZIbHdaU0k2SWsxVFNWTkVUaUlzSW5CaGNuUjVTV1JsYm5ScFptbGxjaUk2SWprME56azBOemswTnprME55SXNJbVp6Y0Vsa0lqb2lZWEJ3YkdWaVlXNXJJbjBzSW5CbGNuTnZibUZzU1c1bWJ5STZleUpqYjIxd2JHVjRUbUZ0WlNJNmV5Sm1hWEp6ZEU1aGJXVWlPaUpOWVhSeklpd2liR0Z6ZEU1aGJXVWlPaUpJWVdkdFlXNGlmU3dpWkdGMFpVOW1RbWx5ZEdnaU9pSXhPVGd6TFRFd0xUSTFJbjE5TENKaGJXOTFiblFpT25zaVlXMXZkVzUwSWpvaU1UQWlMQ0pqZFhKeVpXNWplU0k2SWxWVFJDSjlMQ0owY21GdWMyRmpkR2x2YmxSNWNHVWlPbnNpYzJObGJtRnlhVzhpT2lKVVVrRk9VMFpGVWlJc0ltbHVhWFJwWVhSdmNpSTZJbEJCV1VWU0lpd2lhVzVwZEdsaGRHOXlWSGx3WlNJNklrTlBUbE5WVFVWU0luMTkA",
    "condition": "il1Z7j26cQt8WeIDHjadZaYKDKavNiUFXsaESeW558E"
  }'
```

> There are a few common gotchas at this point:
> - `body.expiration` - Make sure to set this date to be some time in the future, otherwise you will recieve an error callback like so: `eneric validation error - Expiration date ... is already in the past`
> - The `header.Date` format for this request is quite fiddly, and requires a different format for the expiration field. Make sure you use an RFC 2822 formatted date. 
> Make sure to check the transaction callbacks in your docker window to see what is going on. Often you will receive a `/error` callback with a useful description that can help you debug.

**Callback:**
`PUT /transfers/{ID}`
```json
# formatted response
{
  "completedTimestamp": "2021-01-11T06:04:44.144Z",
  "transferState": "COMMITTED",
  "fulfilment": "0zd54QZIdAqqtpTzb-JvkavFCoBHeNHxoDT1IB-8KwA"
}
```

And that's it! The transaction has cleared with Mojaloop. You can now inform your customer that the funds have been sent. Check out [this section of the API spec](https://docs.mojaloop.io/mojaloop-specification/documents/API%20Definition%20v1.0.html#6731-put-transfersid) for an explanation of these fields.